<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(pageTitle='Admin', currentPage='admin', content=~{::content})}">
<body>
<div th:fragment="content">
    <div class="mb-8">
        <h1 class="text-3xl font-bold" style="color: var(--text)">Admin</h1>
        <p class="mt-2" style="color: var(--muted)">Vector store and DeepMath ingestion controls</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Vector Store -->
        <div class="ai-surface rounded-lg p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold" style="color: var(--text)">Vector Store</h2>
                <span id="vs-running" class="text-xs px-2 py-1 rounded status-processing">unknown</span>
            </div>

            <div class="mt-4 text-sm space-y-1" style="color: var(--muted)">
                <div>Rows: <span id="vs-rows" class="font-medium">-</span></div>
                <div>Total problems: <span id="vs-total" class="font-medium">-</span></div>
                <div>Indexed: <span id="vs-indexed" class="font-medium">-</span></div>
                <div>Last error: <span id="vs-error" class="font-medium">-</span></div>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Batch size</label>
                    <input id="vs-batch" type="number" value="200" min="1" max="2000"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Delay (ms)</label>
                    <input id="vs-delay" type="number" value="0" min="0"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button id="vs-reindex"
                        class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium transition ring-1 ring-white/10 ai-glow"
                        style="background: rgba(56,189,248,0.16); color: var(--text)">
                    Reindex problems
                </button>
                <button id="vs-clear"
                        class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium transition ring-1 ring-white/10 hover:bg-white/5"
                        style="color: var(--text)">
                    Clear vector store
                </button>
            </div>

            <p class="mt-4 text-xs" style="color: var(--muted)">
                Reindexing truncates <span class="font-medium">vector_store</span> and rebuilds embeddings.
            </p>
        </div>

        <!-- DeepMath ingestion -->
        <div class="ai-surface rounded-lg p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold" style="color: var(--text)">DeepMath Ingestion</h2>
                <span id="dm-running" class="text-xs px-2 py-1 rounded status-processing">unknown</span>
            </div>

            <div class="mt-4 text-sm space-y-1" style="color: var(--muted)">
                <div>Dataset: <span id="dm-dataset" class="font-medium">-</span></div>
                <div>Split: <span id="dm-split" class="font-medium">-</span></div>
                <div>Progress: <span id="dm-progress" class="font-medium">-</span></div>
                <div>Imported / skipped / failed: <span id="dm-stats" class="font-medium">-</span></div>
                <div>Last error: <span id="dm-error" class="font-medium">-</span></div>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Dataset</label>
                    <input id="dm-dataset-input" type="text" value="zwhe99/DeepMath-103K"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Split</label>
                    <input id="dm-split-input" type="text" value="train"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Config</label>
                    <input id="dm-config-input" type="text" value="default"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Batch size (<=100)</label>
                    <input id="dm-batch" type="number" value="100" min="1" max="100"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Max rows (0=all)</label>
                    <input id="dm-maxrows" type="number" value="0" min="0"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Request delay (ms)</label>
                    <input id="dm-reqdelay" type="number" value="250" min="0"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div class="sm:col-span-2">
                    <label class="inline-flex items-center gap-2 text-sm font-medium" style="color: var(--text)">
                        <input id="dm-index" type="checkbox" class="rounded" style="border-color: var(--border)" />
                        Index embeddings while ingesting
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Index chunk size</label>
                    <input id="dm-index-chunk" type="number" value="100" min="1"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color: var(--text)">Index delay (ms)</label>
                    <input id="dm-index-delay" type="number" value="200" min="0"
                           class="mt-1 block w-full rounded-md border p-2"
                           style="background: rgba(2,6,23,0.35); color: var(--text); border-color: var(--border)" />
                </div>
            </div>

            <div class="mt-6">
                <button id="dm-start"
                        class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium transition ring-1 ring-white/10 ai-glow"
                        style="background: rgba(167,139,250,0.18); color: var(--text)">
                    Start ingestion
                </button>
            </div>

            <p class="mt-4 text-xs" style="color: var(--muted)">
                Uses Hugging Face datasets-server paging (length capped to 100).
            </p>
        </div>
    </div>

    <script>
        async function fetchJson(url) {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            return { ok: res.ok, status: res.status, json: await res.json() };
        }

        function setPill(el, running) {
            el.textContent = running ? 'running' : 'idle';
            el.className = 'text-xs px-2 py-1 rounded ' + (running ? 'status-processing' : 'status-completed');
        }

        async function refreshVectorStore() {
            const pill = document.getElementById('vs-running');
            const data = await fetchJson('/api/admin/vector-store/status');
            if (!data.ok) return;
            const s = data.json;
            setPill(pill, !!s.running);
            document.getElementById('vs-rows').textContent = s.vectorStoreCount ?? '-';
            document.getElementById('vs-total').textContent = s.totalProblems ?? '-';
            document.getElementById('vs-indexed').textContent = s.indexedProblems ?? '-';
            document.getElementById('vs-error').textContent = s.lastError ?? '-';

            const disabled = !!s.running;
            document.getElementById('vs-reindex').disabled = disabled;
            document.getElementById('vs-clear').disabled = disabled;
        }

        async function refreshDeepMath() {
            const pill = document.getElementById('dm-running');
            const data = await fetchJson('/api/admin/ingestion/deepmath/status');
            if (!data.ok) return;
            const s = data.json;
            setPill(pill, !!s.running);

            document.getElementById('dm-dataset').textContent = s.dataset ?? '-';
            document.getElementById('dm-split').textContent = s.split ?? '-';
            const total = s.effectiveTotal ?? s.totalRows;
            const processed = s.processedRows ?? 0;
            document.getElementById('dm-progress').textContent = (total ? (processed + '/' + total) : (processed + '/?'));
            document.getElementById('dm-stats').textContent = `${s.imported ?? 0} / ${s.skipped ?? 0} / ${s.failed ?? 0}`;
            document.getElementById('dm-error').textContent = s.lastError ?? '-';

            const disabled = !!s.running;
            document.getElementById('dm-start').disabled = disabled;

            // best-effort: keep inputs in sync with configured defaults when idle
            if (!s.running && s.dataset) document.getElementById('dm-dataset-input').value = s.dataset;
            if (!s.running && s.split) document.getElementById('dm-split-input').value = s.split;
            if (!s.running && s.config) document.getElementById('dm-config-input').value = s.config;
            if (!s.running && s.batchSize) document.getElementById('dm-batch').value = s.batchSize;
            if (!s.running && s.maxRows !== null && s.maxRows !== undefined) document.getElementById('dm-maxrows').value = s.maxRows;
            if (!s.running && s.requestDelayMs !== null && s.requestDelayMs !== undefined) document.getElementById('dm-reqdelay').value = s.requestDelayMs;
            if (!s.running && s.indexEmbeddings !== null && s.indexEmbeddings !== undefined) document.getElementById('dm-index').checked = !!s.indexEmbeddings;
            if (!s.running && s.indexChunkSize) document.getElementById('dm-index-chunk').value = s.indexChunkSize;
            if (!s.running && s.indexDelayMs !== null && s.indexDelayMs !== undefined) document.getElementById('dm-index-delay').value = s.indexDelayMs;
        }

        document.getElementById('vs-reindex').addEventListener('click', async () => {
            const batch = document.getElementById('vs-batch').value;
            const delay = document.getElementById('vs-delay').value;
            await fetch(`/api/admin/vector-store/reindex-problems?batchSize=${encodeURIComponent(batch)}&delayMs=${encodeURIComponent(delay)}`, { method: 'POST' });
            await refreshVectorStore();
        });

        document.getElementById('vs-clear').addEventListener('click', async () => {
            await fetch('/api/admin/vector-store/clear', { method: 'POST' });
            await refreshVectorStore();
        });

        document.getElementById('dm-start').addEventListener('click', async () => {
            const dataset = document.getElementById('dm-dataset-input').value;
            const split = document.getElementById('dm-split-input').value;
            const config = document.getElementById('dm-config-input').value;
            const batchSize = document.getElementById('dm-batch').value;
            const maxRows = document.getElementById('dm-maxrows').value;
            const requestDelayMs = document.getElementById('dm-reqdelay').value;
            const indexEmbeddings = document.getElementById('dm-index').checked;
            const indexChunkSize = document.getElementById('dm-index-chunk').value;
            const indexDelayMs = document.getElementById('dm-index-delay').value;

            const qs = new URLSearchParams({
                dataset,
                split,
                config,
                batchSize,
                maxRows,
                requestDelayMs,
                indexEmbeddings: String(indexEmbeddings),
                indexChunkSize,
                indexDelayMs
            });

            await fetch(`/api/admin/ingestion/deepmath/start?${qs.toString()}`, { method: 'POST' });
            await refreshDeepMath();
        });

        (async function boot() {
            await refreshVectorStore();
            await refreshDeepMath();
            setInterval(refreshVectorStore, 2000);
            setInterval(refreshDeepMath, 2000);
        })();
    </script>
</div>
</body>
</html>
