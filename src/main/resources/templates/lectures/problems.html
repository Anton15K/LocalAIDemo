<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(pageTitle='Recommended Problems', currentPage='lectures', content=~{::content})}">
<body>
<div th:fragment="content">
    <!-- Header -->
    <div class="mb-6">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="/lectures" style="color: var(--muted)" class="hover:opacity-90">Lectures</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li><a th:href="@{/lectures/{id}(id=${lecture.id})}" style="color: var(--muted)" class="hover:opacity-90" th:text="${lecture.title}">Lecture</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li class="font-medium" style="color: var(--text)">Recommended Problems</li>
            </ol>
        </nav>
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-bold" style="color: var(--text)">Recommended Problems</h1>
                <p class="mt-1 text-sm" style="color: var(--muted)">
                    For: <span class="font-medium" style="color: var(--text)" th:text="${lecture.title}">Lecture</span>
                </p>
            </div>
            <a th:href="@{/lectures/{id}(id=${lecture.id})}" class="px-4 py-2 rounded-md transition text-sm border border-gray-200 hover:bg-gray-50 text-gray-700 shadow-sm">
                Back to Lecture
            </a>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(problems.content)}" class="ai-surface rounded-lg p-10 text-center">
        <h3 class="text-sm font-medium" style="color: var(--text-main)">No problems found</h3>
        <p class="mt-1 text-sm" style="color: var(--text-muted)">Try re-analyzing the lecture or increasing topK.</p>
    </div>

    <div th:unless="${#lists.isEmpty(problems.content)}" class="space-y-4">
        <div th:each="result : ${problems.content}" class="ai-surface rounded-lg p-5">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-100" th:text="${result.problem.topic}">Topic</span>
                        <span th:if="${result.problem.subtopic}" class="px-2 py-1 rounded-full text-xs bg-gray-50 text-gray-700 border border-gray-200" th:text="${result.problem.subtopic}">Subtopic</span>
                        <span th:if="${result.problem.difficulty}" class="text-xs text-gray-400" th:text="'Level ' + ${result.problem.difficulty}">Level</span>
                        <span th:if="${result.matchedTheme}" class="text-xs text-gray-400" th:text="'Matched theme: ' + ${result.matchedTheme}">Matched theme</span>
                    </div>
                    <div class="markdown-content" style="color: var(--text-main)" th:attr="data-raw=${result.problem.statement}">
                        Loading problem...
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs" style="color: var(--text-muted)">Score</div>
                    <div class="text-sm font-medium" style="color: var(--text-main)" th:text="${#numbers.formatDecimal(result.score * 100, 0, 0)} + '%'">85%</div>
                </div>
            </div>
            <div class="mt-3">
                <a th:href="@{/problems/{id}(id=${result.problem.id})}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    View problem + solution â†’
                </a>
            </div>
        </div>

        <!-- Pagination -->
        <div th:if="${problems.totalPages > 1}" class="mt-6 flex items-center justify-between">
            <div class="text-sm" style="color: var(--text-muted)">
                Showing <span th:text="${problems.number * problems.size + 1}">1</span> to
                <span th:text="${problems.number * problems.size + problems.numberOfElements}">20</span> of
                <span th:text="${problems.totalElements}">100</span> problems
            </div>
            <div class="flex space-x-2">
                <a th:unless="${problems.first}"
                   th:href="@{/lectures/{id}/problems(id=${lecture.id}, page=${problems.number - 1}, size=${problems.size}, topK=${topK})}"
                   class="px-4 py-2 rounded-md text-sm transition border border-gray-200 hover:bg-gray-50 text-gray-700 shadow-sm">Previous</a>
                <span class="px-4 py-2 text-sm" style="color: var(--text-muted)">
                    Page <span th:text="${problems.number + 1}">1</span> of <span th:text="${problems.totalPages}">10</span>
                </span>
                <a th:unless="${problems.last}"
                   th:href="@{/lectures/{id}/problems(id=${lecture.id}, page=${problems.number + 1}, size=${problems.size}, topK=${topK})}"
                   class="px-4 py-2 rounded-md text-sm transition border border-gray-200 hover:bg-gray-50 text-gray-700 shadow-sm">Next</a>
            </div>
        </div>
    </div>

    <script th:inline="none">
        (function() {
            function normalizeMathDelimiters(text) {
                if (!text) return '';
                return text
                    .replace(/\\\[/g, '$$$$')
                    .replace(/\\\]/g, '$$$$')
                    .replace(/\\\(/g, '$$')
                    .replace(/\\\)/g, '$$');
            }

            function protectMath(text) {
                const math = [];
                let i = 0;
                // 1. Protect display math $$...$$
                text = text.replace(/\$\$([\s\S]+?)\$\$/g, (match) => {
                    math.push(match);
                    return `@@MATH${i++}@@`;
                });
                // 2. Protect inline math $...$
                text = text.replace(/(^|[^\\])\$([^\s$][^$\n]*?[^\s$])\$/g, (match, prefix, content) => {
                    math.push(`$${content}$`);
                    return `${prefix}@@MATH${i++}@@`;
                });
                // Special case for single character math like $x$
                text = text.replace(/(^|[^\\])\$([^\s$])\$/g, (match, prefix, content) => {
                    math.push(`$${content}$`);
                    return `${prefix}@@MATH${i++}@@`;
                });
                return { text, math };
            }

            function restoreMath(html, math) {
                return html.replace(/@@MATH(\d+)@@/g, (_, i) => math[i]);
            }

            function renderAll() {
                const els = document.querySelectorAll('.markdown-content');
                els.forEach(el => {
                    const raw = el.getAttribute('data-raw');
                    if (raw && raw.trim().length > 0) {
                        try {
                            if (window.marked && window.marked.parse) {
                                const normalized = normalizeMathDelimiters(raw);
                                const { text, math } = protectMath(normalized);
                                let html = marked.parse(text);
                                html = restoreMath(html, math);
                                el.innerHTML = html;
                            } else {
                                el.innerHTML = '<pre style="white-space: pre-wrap">' + raw + '</pre>';
                            }
                        } catch (err) {
                            console.error('Render error:', err);
                            el.innerHTML = raw;
                        }
                    }
                });
                
                if (window.MathJax?.typesetPromise) {
                    window.MathJax.typesetPromise().catch(err => console.error('MathJax error:', err));
                } else if (window.typesetMath) {
                    window.typesetMath();
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', renderAll);
            } else {
                renderAll();
            }

            // Retry typeset
            let left = 10;
            const id = setInterval(() => {
                left -= 1;
                if (window.MathJax?.typesetPromise) {
                    if (window.MathJax.typesetPromise) window.MathJax.typesetPromise();
                    clearInterval(id);
                } else if (left <= 0) {
                    clearInterval(id);
                }
            }, 500);
        })();
    </script>
</div>
</body>
</html>
